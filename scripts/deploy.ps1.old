param(
    $Host = 'ftp.davison.link',
    $Port = 21,
    $User = 'filmfinder@films.notperfect.biz',
    $Password = 'Cornflakes1!!',
    $RemoteBase = '/public_html/filmfinder'
)

$remoteUri = "ftp://$Host$RemoteBase"
$creds = New-Object System.Net.NetworkCredential($User, $Password)

function UploadFile {
    param($localPath, $remotePath)
    $request = [System.Net.FtpWebRequest]::Create("$remotePath")
    $request.Method = [System.Net.WebRequestMethods+Ftp]::UploadFile
    $request.Credentials = $creds
    $request.UseBinary = $true
    $request.EnableSsl = $true
    $fileBytes = [System.IO.File]::ReadAllBytes($localPath)
    $request.ContentLength = $fileBytes.Length
    $requestStream = $request.GetRequestStream()
    $requestStream.Write($fileBytes, 0, $fileBytes.Length)
    $requestStream.Close()
    $response = $request.GetResponse()
    $response.Close()
}

function EnsureRemoteFolder {
    param($path)
    $segments = $path.Trim('/').Split('/')
    $accum = ''
    foreach ($segment in $segments) {
        $accum += "/$segment"
        $req = [System.Net.FtpWebRequest]::Create("ftp://$Host$accum")
        $req.Method = [System.Net.WebRequestMethods+Ftp]::MakeDirectory
        $req.Credentials = $creds
        $req.EnableSsl = $true
        try { $req.GetResponse() | Out-Null } catch {}
    }
}

$files = Get-ChildItem -Recurse -File | Where-Object { $_.FullName -notlike '*\.git*' -and $_.FullName -notmatch '\\storage\\cache\\' -and $_.Name -notmatch '^\.env' }
foreach ($file in $files) {
    $relative = $file.FullName.Substring((Get-Location).Path.Length).TrimStart('\')
    $remotePath = "$remoteUri/$($relative -replace '\\','/')"
    $folder = Split-Path $remotePath -Parent
    EnsureRemoteFolder($folder.Substring("ftp://$Host".Length))
    Write-Host "Uploading $relative"
    UploadFile -localPath $file.FullName -remotePath $remotePath
}
